## Декомпозиция микросервисов для создания интернет-магазина

1. [Пользовательские сценарии](#Пользовательские-сценарии)
2. [Системные действия](#Системные-действия)
3. [Модель на основе ООП](#Модель-на-основе-ООП)
4. [Функциональная модель](#Функциональная-модель)
5. [Итоговая модель](#Итоговая-модель)
6. [Схема взаимодействия сервисов](#Схема-взаимодействия-сервисов)
7. [Системные действия в виде API](#Системные-действия-в-виде-API)
8. [Описание сервисов](#Описание-сервисов)


### Пользовательские сценарии

Есть клиент  
И есть интернет-магазин  
И клиент вводит в строке поиска "Велосипед"  
Тогда появляется список товаров, подходящих под запрос клиента

Когда клиент нажимает карточку на товар в списке результатов поиска  
Тогда клиент переходит на карточку с описанием товара

Когда клиент нажимает на кнопку "Добавить в корзину"  
Тогда товар добавляется в корзину

Когда клиент переходит в корзину  
Тогда он видит список всех добавленных им в корзину товаров

Когда клиент нажимает на кнопку "Удалить из корзины"  
Тогда товар удаляется из корзины

Когда клиент нажимает в корзине на кнопку +1 или -1 для товара  
Тогда количество единиц данного товара меняется соответственно нажатой кнопке

Когда клиент нажимает на кнопку "Оформить заказ"   
Тогда клиент переходит на страницу оформления заказа, которая предлагает заполнить адрес и дату доставки или же использовать данные по умолчанию

Когда клиент при оформлении заказа переходит к оплате  
Тогда возникает форма оплаты

Когда клиент производит оплату заказа  
Тогда появляется окно "Заказ оплачен"  
И клиенту приходит уведомление с информацией о заказе и успешной оплате  
И заказ резервируется на складе  
И создаётся заявка для службы доставки


### Системные действия:
- клиент может искать товар, используя те или иные фильтры
- клиент может получить информацию о товаре
- клиент может положить товар в корзину
- клиент может удалить товар из корзины
- клиент может изменить количество добавленных в корзину товаров
- клиент может оформить заказ
- клиент может указать адрес, время и дату доставки
- клиент может выбрать способ оплаты
- клиент может оплатить заказ
- приложение отправляет клиенту уведомление с информацией о сделанном заказе
- приложение отправляет клиенту уведомление об успешной/неуспешной оплате
- приложение резервирует товар на складе после оформления заказа
- приложение передаёт заказ в службу доставки


### Модель на основе ООП

Основные сущности:
- Клиент
- Товар
- Корзина
- Заказ
- Уведомление
- Склад
- Оплата
- Служба доставки

![model](./images/model.png)

Сервисы:
- ClientService
- ProductService
- CartService
- OrderService
- NotificationService
- WarehouseService

А также:
- PaymentService
- DeliveryService


### Функциональная модель

![model](./images/functional-model.png)

Сервисы:
- ProductSearchService (поиск товара и просмотр информации о нём)
- OrderService (добавление/удаление товаров в корзине и оформление заказа)
- WarehouseService (передача информации о заказе на склад) 
- NotificationService (отправка уведомлений)
- PaymentService (оплата заказа)
- DeliveryService (передача заказа в службу доставки)

### Итоговая модель

Доработка модели:
- Поскольку работа с корзиной во многом связано с оформлением заказа, 
сервисы CartService и OrderService, получившиеся в модели на основе ООП, сильно связные.
Есть смысл объединить их в один - OrderService (он же получился и в функциональной модели).

Сервисы:
- Client
- ProductCatalog
- Order
- Payment
- Warehouse
- Delivery
- Notification

### Схема взаимодействия сервисов

![services](./images/services.png)

### Системные действия в виде API

**ms_client**
- создание клиента: POST /api/v1/clients/ {name, email, default_delivery_address, default_payment_method}  
- получение клиента по id: GET /api/v1/clients/{id}

**ms_product_catalog**
- создание фильтра: POST /api/v1/filters/ {name, color}
- поиск товаров по id фильтра: GET /api/v1/products/search?query={id}
- получение информации о товаре по id: GET /api/v1/products/{id}
- получение события о бронировании товара или поступлении нового: EVENT {type, product_id, quantity}
- получение события о поступлении нового товара на склад: EVENT {product_name, color, quantity}

**ms_order**
- получение корзины по id: GET /api/v1/carts/{id}
- создание корзины: POST /api/v1/carts/ {client_id}
- изменение корзины: PUT /api/v1/carts/{id} {product_items[]}


- получение заказа по id: GET /api/v1/orders/{id}
- получение всех заказов клиента: GET /api/v1/orders/{clientId}
- создание заказа: POST /api/v1/orders { client_id, delivery_time, delivery_address, product_items[] }
- изменение заказа: PUT /api/v1/orders/{id} { client_name, delivery_time, delivery_address, product_items[] }
- отмена заказа: DELETE /api/v1/orders/{id}

- получение события об оплате заказа: EVENT {order_id}

**ms_payment**
- оплата: POST /api/v1/pay {order_id, total_price}

**ms_warehouse**
- передача данных о заказе на склад: POST /api/v1/reserve {oder}

**ms_delivery**
- передача заказа в сервис доставки: POST /api/v1/delivery {order}

**ms_notification**
- отправка уведомления о заказе: EVENT {message_type, client_id, order_id}
- отправка уведомления об оплате: EVENT {message_type, client_id}

где
product_items[] = product_items: [{product_id, quantity}, ...]

### Описание сервисов

----------------------

**Название**: ms_client  
**Описание**: Сервис для хранения информации о клиента. 
При запросе всех заказов клиента обращается в сервис ms_order.  
**Запросы**:
- получение клиента по id: GET /api/v1/clients/{id}

**Команды**:
- создание клиента: POST /api/v1/clients/ {name, email, default_delivery_address, default_payment_method}

**События**: -  
**Зависимости**:
- получение всех заказов клиента от ms_order

**Вопросы**: -

----------------------

**Название**: ms_product_catalog  
**Описание**: Сервис для поиска товаров и хранения информации о них. 
Слушает события об изменении количества товаров и поступлении новых от склада.  
**Запросы**:
- поиск товаров по id фильтра: GET /api/v1/products/search?query={id}
- получение информации о товаре по id: GET /api/v1/products/{id}

**Команды**:
- создание фильтра: POST /api/v1/filters/ {name}

**События**: -  
**Зависимости**:
- событие от ms_warehouse о бронировании товара или поступлении нового: EVENT {type, product_id, quantity}
- событие от ms_warehouse о поступлении нового товара на склад: EVENT {product_name, color, quantity}

**Вопросы**:
- Хранить товары в монге?
- Поиск через эластик?

----------------------
**Название**: ms_order  
**Описание**: Сервис для работы с корзиной и оформлением заказа. 
После оформления заказа направляет клиента в сервис оплаты, после чего передаёт заказ на склад.  
**Запросы**:
- получение корзины по id: GET /api/v1/carts/{id}
- получение заказа по id: GET /api/v1/orders/{id}
- получение всех заказов клиента: GET /api/v1/orders/{clientId}

**Команды**:
- создание корзины: POST /api/v1/carts/ {client_id}
- изменение корзины: PUT /api/v1/carts/{id} {product_items[]}
- создание заказа: POST /api/v1/orders { client_id, delivery_time, delivery_address, product_items[] }
- изменение заказа: PUT /api/v1/orders/{id} { client_name, delivery_time, delivery_address, product_items[] }
- отмена заказа: DELETE /api/v1/orders/{id}

**События**:
- событие о созданном заказе: EVENT {message_type, client_id, order_id}
**Зависимости**:
- получение адреса клиента от ms_client
- получение цены товара от ms_product_catalog
- событие от ms_payment об оплате заказа: EVENT {order_id}

**Вопросы**:
- После создания заказа корзина очищается или же создаётся новая? Логичнее очищать
----------------------
**Название**: ms_payment  
**Описание**: Сервис оплаты. Отправляет событие об статусе оплаты для заказа.  
**Запросы**:  
**Команды**:
- POST /api/v1/pay {order_id, total_price}

**События**:
- отправляет событие об оплате заказа: EVENT {order_id}

**Зависимости**: -  
**Вопросы**: -
----------------------
**Название**: ms_warehouse  
**Описание**: Сервис склада. Хранит информацию о товарах и их количестве, 
новые товары регистрируются администратором в нём, после чего сервис отправляет событие о них. Передаёт заказы в доставку.  
**Запросы**: -  
**Команды**:
- передача данных о заказе на склад: POST /api/v1/reserve {oder}

**События**:
- событие о бронировании товара или поступлении нового: EVENT {type, product_id, quantity}
- событие о поступлении нового товара на склад: EVENT {product_name, color, quantity}

**Зависимости**: -  
**Вопросы**: -
----------------------

**Название**: ms_delivery  
**Описание**: Сервис доставки заказов клиентам.  
**Запросы**: -  
**Команды**:
- передача заказа в сервис доставки: POST /api/v1/delivery {order}

**События**: -  
**Зависимости**: -  
**Вопросы**: -  
----------------------

**Название**:  ms_notification  
**Описание**: Сервис отправки уведомлений клиентам.  
**Запросы**: -  
**Команды**: -  
**События**: -  
**Зависимости**:
- событие от ms_order для отправки уведомления клиенту о заказе: EVENT {message_type, client_id, order_id}
- событие для ms_payment отправки уведомления клиенту об оплате: EVENT {message_type, client_id}
- получение email-адреса клиента от ms_client
- получение данных о заказе от ms_order

**Вопросы**: -
